---
title: "Testing background point generation in modleR"
author: "Andrea Sánchez-Tapia & Sara Mortara"
date: "`r Sys.Date()`"
output:
  html_document: 
    number_sections: true
  pdf_document: default
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = T)
```

This workflow tests background point generation in `modleR`. We perform tests with different types of buffer and different code options to sample pseudoabsences inside a geographic buffer. Later, we explore how different methods for sampling pseudoabsences results on different model predictions. 

To run this example you will need `modleR`and the additional packages `rJava`, `raster`, and `dplyr`. To check if they are already installed and install eventually missing packages run the code below.

```{r,  message=FALSE, eval=FALSE}
packages <- c("rJava", "raster", "dplyr", "devtools")
instpack <- packages[!packages %in% installed.packages()]
if(length(instpack)>0) {
    install.packages(packages[!packages %in% installed.packages()])
}
```

If you don't have `modleR` installed, run:

```{r,  eval=F}
devtools::install_github("Model-R/modleR", ref = "master")
```

Then, load all required packages. 

```{r load}
library(rJava)
library(raster)
library(dplyr)
#library(modleR)
#eu estou usando uma cópia local para desenvolvimento
devtools::load_all("../../modleR")
```

# The example data set 

We use a standard dataset inside the package `modleR`. First, from `coordenadas` object we select only data from one species *Abarema langsdorffii* and create one training set (70% of the data) and one test set (30% of the data) for the data. 

```{r dataset}
## Creating an object with species names
especies <- names(coordenadas)[1]
# Selecting only coordinates for the first species
coord1sp <- coordenadas[[1]]
head(coord1sp)
dim(coord1sp)
# Subsetting data into training and test
ceiling(0.7 * nrow(coord1sp))
# Making a sample of 70% of species' records
set <- sample(1:nrow(coord1sp), size = ceiling(0.7 * nrow(coord1sp)))
# Creating training data set (70% of species' records)
train_set <- coord1sp[set,]
# Creating test data set (other 30%)
test_set <- coord1sp[setdiff(1:nrow(coord1sp),set),]
```

Now lets the check our data points. We plot the traning and test data sets with the first axis of the environmental PCA data from the object `example_vars`.  

```{r plotdataset}
# selecting only the first PCA axis
#isto dá erro em environmental distance porque não sabe calcular com apply - botei uma questão de dimensão
predictor <- example_vars[[1]]
# transforming the data frame with the coordinates in a spatial object
pts <- SpatialPoints(coord1sp[,c(2,3)])
# ploting environmental layer
plot(predictor, legend = F)
# adding training data set in red
points(train_set[,2:3], col = "red", pch = 19)
# adding test data set in blue
points(test_set[,2:3], col = "blue", pch = 19)
```

# Function `create_buffer()` and `setup_sdmdata()`

Here, for all types of buffer, first we create an object with `create_buffer()` using different types of buffer and then generate the background values with `randomPoints()` from `dismo` package. 

Another option for creating any type of buffer is using function `setup_sdmdata()` from `modleR`, this function calls `create_buffer()` and performs the sampling, so there is no need to call for `dismo::randomPoints()` or `modleR::create_buffer()` from `modleR`.  

We implemented three types of buffer that can be combined: (A) geographic distance buffers (B) environmental distance buffer (C) a "minimal distance" exclusion buffer, to avoida areas that are very close to the occurrence points. 

- __(A)__ geographic distance buffers: 
  - `max`: the maximum distance between any two occurrence points
  - `mean`: the mean distance between all occurrence points
  - `median`: the median of the pairwise distance between occurrence points
  - `distance`: the user can specify a particular distance to be used as buffer width - in raster units
- __(A')__  Instead of using a distance for the buffer construction, option `user` allows the user to provide their own shapefile as available area (M) to sample pseudoabsences

- (B) an `environmental distance` buffer that samples within areas with environmental affinities
- a minimum distance (`mindist`) exclusion buffer, that excludes points that are too close to the occurrence points, in order to avoid overfitting

Figure 1 explains the possible combinations of these three kinds of buffers.



## Pseudoabsence selection without any buffer


First, directly from `randomPoints`.

```{r nobuffer dismo, echo = F, eval = T}
# creating 500 background values with randomPoints
rand <- dismo::randomPoints(predictor,
                    n = 500,
                    excludep = T,
                    p = pts)
# ploting environmental layer with background values
plot(predictor, legend = F, main = "nobuffer randomPoints")
points(rand, col = "red")
```

then from `setup_sdmdata`:

Here we specify `buffer_type = NULL` to perform background point generation. 

```{r sdmdatanull, eval = T}
# background point generation inside setup_sdmdata
a <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[,-1],
              predictors = example_vars,
              models_dir = "./buffer_res/ss_no_buf",
              buffer_type = NULL, # no buffer
              clean_dupl = T,
              clean_nas = T,
              seed = 512)
# plotting background point generation
knitr::include_graphics("./buffer_res/ss_no_buf/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")
```


## Pseudoabsence selection using `create_buffer()` and `randomPoints()` or `setup_smdata()`




### Inclusion buffer with maximum distance `max`

In this example, we use `buffer_type = "maximum"` to generate our first object.

```{r buffermax, echo = F, eval = T, warning = F}
#par(mfrow = c(1,1))
# creating an object with create_buffer with maximum distance buffer type
buf.max <- create_buffer(occurrences = coord1sp[,c(2,3)],
                         predictors = predictor,
                         buffer_type = "maximum")
# creating 500 background values from buf.max
buf.max.p <- dismo::randomPoints(buf.max,
                    n = 500,
                    excludep = T,
                    p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor,
     legend = F, main = "buffer max")
## adding buf.max
plot(buf.max, add = T, legend = F, 
     col = scales::alpha("grey", 0.5), border = "black")
## adding buf.max.p
points(buf.max.p, col = "blue", pch = 19, cex = 0.7)
```

### Inclusion buffer with `mean` distance 

In this example, we use `buffer_type = "mean"`. 

```{r buffermean, echo = F, eval = T, warning = F}
#par(mfrow = c(1,1))
# creating an object with buffer_type="mean"
buf.mean <- create_buffer(occurrences = coord1sp[,c(2,3)],
                     predictors = predictor,
                     buffer_type = "mean")
# using buf.mean to generate 500 background values
buf.mean.p <- dismo::randomPoints(buf.mean,
                    n = 500,
                    excludep = T,
                    p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor,
     legend = F, main = "buffer mean")
## adding buf.mean
plot(buf.mean, add = T, legend = F, 
     col = scales::alpha("grey", 0.5), border = "black")
## adding buf.mean.p
points(buf.mean.p, col = "blue")
```

### Inclusion buffer with `median` of distances

In this example, we use `buffer_type="median"`

```{r buffermedian, echo = F, eval = T, warning=F}
#par(mfrow = c(1,1))
# creating an object with buffer_type=median
buf.med <- create_buffer(occurrences = coord1sp[,c(2,3)],
                     predictors = predictor,
                     buffer_type = "median")
# using buf.med to generate 500 background values
buf.med.p <- dismo::randomPoints(buf.med,
                    n = 500,
                    excludep = T,
                    p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor,
     legend = F, main = "buffer median")
## adding buf.med
plot(buf.med, add = T, legend = F, 
     col = scales::alpha("grey", 0.5), border = "black")
## adding buf.med.p
points(buf.med.p, col = "blue")
```

### Inclusion buffer with a specific `distance`

In this example we specify a particular distance from each point to sample pseudoabsences inside the buffer. We use `buffer_type = "distance"` and `dist_buf = 5`. Be aware that `dist_buf` must be set when using a distance buffer. 

```{r bufferdistance, echo = F, eval = T, warning=F}
# creating buffer with 5 km distance
buf.dist <- create_buffer(occurrences = coord1sp[,c(2,3)],
                     predictors = predictor,
                     buffer_type = "distance",
                     dist_buf = 5)
# using buf.dist to generate 500 pseudoabsences
buf.dist.p <- dismo::randomPoints(buf.dist,
                    n = 500,
                    excludep = T,
                    p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor,
     legend = F, main = "buffer distance")
## adding buff.dist
plot(buf.dist, add = T, legend = F, 
     col = scales::alpha("grey", 0.5), border = "black")
## adding buf.dist.p
points(buf.dist.p, col = "blue")
```

### Inclusion buffer within a user-defined shapefile (`user` and `buffer_shape`)

In this example we specify a shapefile that we use as the buffer. Please note that a `buffer_shape` must be included in order to use this buffer. 

```{r}
myshapefile <- rgdal::readOGR("../data/myshapefile.shp")
buf.user <- create_buffer(occurrences = coord1sp[,c(2,3)],
                          predictors = predictor,
                     buffer_type = "user",
                     buffer_shape = myshapefile)
# using buf.dist to generate 500 pseudoabsences
buf.user.p <- dismo::randomPoints(buf.user,
                                  n = 500,
                                  excludep = T,
                                  p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor,
     legend = F, main = "user-defined buffer")
## adding buff
plot(buf.user, add = T, legend = F, 
     col = scales::alpha("grey", 0.5), border = "black")
## adding buf.user.p
points(buf.user.p, col = "blue")
```

### Inclusion buffer using a euclidean environmental distance

In addition to geographic distance buffers, we can apply an environmental distance buffer, that sets the area available for pseudoabsence sampling as a function of the environmental conditions found at the occurrence points.
Since environmental distances can take large values, the user may set a maximum envorinmental distance, expressed in quantile form, to set a maximum distance in order tu cut (and create) this buffer. The default value is 0.5, the median of the distances found along the areas. 


NOTE: THE ENVIRONMENTAL DISTANCE BUFFER CAN BE APPLIED SIMULTANEOUSLY WITH OTHER DISTANCE BUFFERS


#### Sem buffer_type 

```{r}
#the environmental distance filter works with a stack, rather than a single layer (ö testar com poucos pontos, pois não faz sentido cortar pela mediana com n 1 ou 2)
predictor <- example_vars
buf.env <- create_buffer(occurrences = coord1sp[,c(2,3)],
                         predictors = predictor,
                         buffer_type = "none",
                         env_buffer = T,
                         env_distance = "centroid",
                         max_env_dist = 0.5)

# using buf.env to generate 500 pseudoabsences
buf.env.p <- dismo::randomPoints(buf.env,
                                  n = 500,
                                  excludep = T,
                                  p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor[[1]],
     legend = F, main = "environmental distance buffer")
## adding buff
plot(buf.env[[1]], add = T, legend = F, 
     col = scales::alpha("grey", 0.8), border = "black")
## adding buf.user.p
points(buf.env.p, col = "blue")

```

#### Com `buffer_type`

```{r}
#the environmental distance filter works with a stack, rather than a single layer (ö testar com poucos pontos, pois não faz sentido cortar pela mediana com n 1 ou 2)

buf.env <- create_buffer(occurrences = coord1sp[,c(2,3)],
                         predictors = predictor,
                         buffer_type = "maximum",
                         env_buffer = T,
                         env_distance = "centroid",
                         max_env_dist = 0.5)

# using buf.env to generate 500 pseudoabsences
buf.env.p <- dismo::randomPoints(buf.env,
                                  n = 500,
                                  excludep = T,
                                  p = pts)
# plotting environmental layer with background values
## environmental layer
plot(predictor[[1]],
     legend = F, main = "environmental distance buffer x maximum distance buffer")
## adding buff
plot(buf.env, add = T, legend = F, 
     col = scales::alpha("grey", 0.8), border = "black")
## adding buf.user.p
points(buf.env.p, col = "blue")

```



### The `mindist` _exclusion_ buffer

In addition to the combination of distance and environmental buffers, we implemented the __exclusion__ of points that are too close to the occurrence records, to control for overfitting. All distance buffers can be used with the additional parameter `mindist`. <!-- maybe exclusion_distance? -->

```{r MINDIST, eval = T}
#maxdist + mindist
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/mindist_maxdist",
              buffer_type = "maximum",
              dist_min = 3,
              clean_dupl = T,
              clean_na = T)
knitr::include_graphics("./buffer_res/mindist_maxdist/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")
#mean + mindist
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/mindist_meandist",
              buffer_type = "mean",
              dist_min = 3,
              clean_dupl = T,
              clean_na = T)
knitr::include_graphics("./buffer_res/mindist_meandist/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")
#median + mindist
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/mindist_mediandist",
              buffer_type = "median",
              dist_min = 3,
              clean_dupl = T,
              clean_na = T)
knitr::include_graphics("./buffer_res/mindist_mediandist/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")

#geog.distance + mindist
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/mindist_distance",
              buffer_type = "distance",
              dist_min = 3,
              clean_dupl = T,
              clean_na = T,
              dist_buf = 7)
knitr::include_graphics("./buffer_res/mindist_distance/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")

#user + mindist
myshapefile <- rgdal::readOGR("../data/myshapefile.shp")
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/mindist_usrshp",
              buffer_type = "user",
              buffer_shape = myshapefile,
              dist_min = 3,
              clean_dupl = T,
              clean_nas = T)
knitr::include_graphics("./buffer_res/mindist_usrshp/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")

#ENV + mindist
m <- setup_sdmdata(species_name = especies[1],
              occurrences = coord1sp[, -1],
              predictors = example_vars,
              models_dir = "./buffer_res/envdist_usrshp",
              buffer_type = "environmental_distance",
              dist_min = 3,
              clean_dupl = T,
              clean_nas = T)
knitr::include_graphics("./buffer_res/envdist_usrshp/Abarema_langsdorffii/present/data_setup/sdmdata_Abarema_langsdorffii.png")
```


# una figura para la vignette
```{r}
buf <- c("a", "user", "maximum", "mean","median")
env <- c(F, T)
dist_min <- c(0, 1)
expand.grid(buffer_type = buf, env_filter = env, dist_min = dist_min)

```

